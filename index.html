<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio OISC - Hello World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        body { font-family: 'Fira Code', monospace; background-color: #0b1020; color: #e5e7eb; }
        .code-input { background: #0f172a; color: #22d3ee; border: 1px solid #1f2a44; }
    </style>
</head>
<body class="p-3 md:p-5">
    <div class="w-full max-w-none mx-auto">
        <header class="mb-6 md:mb-8">
            <div class="rounded-2xl border border-slate-700 bg-gradient-to-r from-slate-900 via-slate-900/60 to-slate-900/20 p-5">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <h1 class="text-2xl md:text-3xl font-bold text-cyan-300">OISC Emulator (SUBLEQ)</h1>
                    <span class="text-xs text-slate-400">Mem[B] = Mem[B] - Mem[A]; se Mem[B] <= 0, salta para C</span>
                </div>
                <p class="text-slate-400 mt-2">Instrucao unica: <code>SUBLEQ A, B, C</code></p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-[1fr_1.1fr] gap-5">
            <section class="rounded-2xl border border-slate-700 bg-slate-900/40 p-5">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <h2 class="text-lg font-semibold text-slate-200">Editor e Controles</h2>
                </div>

                <div class="mt-4 grid grid-cols-1 gap-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-200">Status</h2>
                        <div id="status" class="mt-3 p-4 rounded-xl bg-slate-800 border border-slate-700 h-16 flex items-center italic text-slate-400">
                            Aguardando execucao...
                        </div>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold text-slate-200">Saida do Console</h2>
                        <div id="console" class="mt-3 p-4 rounded-xl bg-black text-green-400 h-32 overflow-y-auto border border-slate-700 font-bold text-lg">
                            > _
                        </div>
                    </div>
                </div>

                <textarea id="editor" class="code-input w-full h-64 mt-4 p-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="Ex: 10 10 3 ..."></textarea>

                <div class="mt-4 rounded-xl border border-slate-700 bg-slate-900/60 p-4 text-sm text-slate-400">
                    <p class="font-semibold text-slate-200">Organizacao da memoria</p>
                    <p class="mt-2">1) Dados no inicio (ex: ASCII de "Hello World").</p>
                    <p>2) Instrucoes depois, sempre em trios A B C.</p>
                    <p>3) Defina o PC inicial para iniciar a execucao.</p>
                </div>

                <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-slate-300">
                    <label for="pcInicial" class="text-slate-400">PC inicial (obrigatorio):</label>
                    <input id="pcInicial" type="number" min="0" step="1" class="w-28 rounded-md border border-slate-600 bg-slate-900 px-2 py-1 text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="ex: 11" required>
                    <span class="text-xs text-slate-500">Informe o endereco da primeira instrucao.</span>
                </div>

                <div class="mt-4 flex flex-wrap gap-3">
                    <button onclick="executar()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-2 rounded-lg font-bold transition">RUN & VALIDATE</button>
                    <button onclick="executarPasso()" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-lg font-bold transition">PASSO</button>
                    <button onclick="carregarExemplo()" class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-5 py-2 rounded-lg font-semibold transition">Carregar ASCII</button>
                    <button onclick="limparMemoria()" class="bg-slate-800 hover:bg-slate-700 text-slate-200 px-5 py-2 rounded-lg font-semibold transition">Limpar memoria</button>
                </div>
            </section>

            <section class="rounded-2xl border border-slate-700 bg-slate-900/40 p-5">
                <div>
                    <h2 class="text-lg font-semibold text-slate-200">Registradores (passo atual)</h2>
                    <div class="mt-3 grid grid-cols-3 gap-3 text-sm">
                        <div class="rounded-xl border border-slate-700 bg-slate-900/70 p-3">
                            <div class="text-slate-500">A</div>
                            <div id="regA" class="text-slate-100 font-semibold">-</div>
                        </div>
                        <div class="rounded-xl border border-slate-700 bg-slate-900/70 p-3">
                            <div class="text-slate-500">B</div>
                            <div id="regB" class="text-slate-100 font-semibold">-</div>
                        </div>
                        <div class="rounded-xl border border-slate-700 bg-slate-900/70 p-3">
                            <div class="text-slate-500">C</div>
                            <div id="regC" class="text-slate-100 font-semibold">-</div>
                        </div>
                    </div>
                </div>

                <div class="mt-5 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-200">Memoria (visualizacao)</h2>
                    <span class="text-xs text-slate-500">Destaque = PC atual</span>
                </div>
                <div id="memoryGrid" class="mt-4 grid grid-cols-8 sm:grid-cols-10 md:grid-cols-12 lg:grid-cols-16 gap-2 text-xs"></div>
            </section>
        </div>

        <footer class="mt-6 rounded-2xl border border-slate-700 bg-slate-900/40 p-5">
            <h3 class="text-cyan-300 font-bold mb-2">Dica para o desafio</h3>
            <p class="text-sm text-slate-300">
                Use o endereco <strong>-1</strong> para imprimir o caractere no endereco A.<br>
                Exemplo: <code>5 -1 3</code> imprime o caractere armazenado na posicao 5 da memoria e salta para a instrucao 3.
            </p>
            <button onclick="carregarRR()" style="justify-content: center;">Carregue a surpresa</p>
        </footer>
    </div>

    <script>
        const MEM_SIZE = 64;
        let memoriaState = Array(MEM_SIZE).fill(0);
        let pcState = null;
        let outputState = "";
        let ciclosState = 0;

        const editorEl = document.getElementById('editor');
        const statusDiv = document.getElementById('status');
        const consoleDiv = document.getElementById('console');
        const memoryGrid = document.getElementById('memoryGrid');
        const regAEl = document.getElementById('regA');
        const regBEl = document.getElementById('regB');
        const regCEl = document.getElementById('regC');

        function setRegs(a, b, c) {
            regAEl.innerText = a ?? "-";
            regBEl.innerText = b ?? "-";
            regCEl.innerText = c ?? "-";
        }

        function renderMemory() {
            let html = "";
            for (let i = 0; i < MEM_SIZE; i++) {
                const isPc = pcState === i;
                const value = memoriaState[i] ?? 0;
                const baseClass = "rounded-lg border border-slate-700 bg-slate-900/70 p-2 text-slate-200";
                const pcClass = isPc ? " ring-2 ring-cyan-400" : "";
                html += `<div class="${baseClass}${pcClass}">
                            <div class="text-slate-500">${i}</div>
                            <div class="text-slate-100 font-semibold">${value}</div>
                         </div>`;
            }
            memoryGrid.innerHTML = html;
        }

        function parseTokens(raw) {
            if (!raw) {
                return { ok: true, tokens: [] };
            }
            const tokens = raw.split(/\s+/).map(Number);
            if (tokens.some(Number.isNaN)) {
                return { ok: false, error: "Erro: o codigo deve conter apenas numeros." };
            }
            return { ok: true, tokens };
        }

        function syncMemoryFromEditor() {
            const raw = editorEl.value.trim();
            const parsed = parseTokens(raw);
            if (!parsed.ok) {
                return;
            }
            memoriaState = Array(MEM_SIZE).fill(0);
            for (let i = 0; i < Math.min(parsed.tokens.length, MEM_SIZE); i++) {
                memoriaState[i] = parsed.tokens[i];
            }
            pcState = null;
            outputState = "";
            ciclosState = 0;
            consoleDiv.innerText = "> _";
            setRegs(null, null, null);
            renderMemory();
        }

        function prepararExecucao() {
            const raw = editorEl.value.trim();
            if (!raw) {
                statusDiv.innerHTML = "Erro: o codigo deve conter apenas numeros.";
                statusDiv.className = "mt-3 p-4 rounded-xl bg-red-900/30 border border-red-500 h-16 flex items-center text-red-400";
                return false;
            }

            const parsed = parseTokens(raw);
            if (!parsed.ok) {
                statusDiv.innerHTML = parsed.error;
                statusDiv.className = "mt-3 p-4 rounded-xl bg-red-900/30 border border-red-500 h-16 flex items-center text-red-400";
                return false;
            }

            const pcInput = document.getElementById('pcInicial').value.trim();
            if (pcInput === "") {
                statusDiv.innerHTML = "Erro: PC inicial obrigatorio.";
                statusDiv.className = "mt-3 p-4 rounded-xl bg-red-900/30 border border-red-500 h-16 flex items-center text-red-400";
                return false;
            }
            const parsedPc = Number(pcInput);
            if (!Number.isInteger(parsedPc) || parsedPc < 0) {
                statusDiv.innerHTML = "Erro: o PC inicial deve ser um numero inteiro >= 0.";
                statusDiv.className = "mt-3 p-4 rounded-xl bg-red-900/30 border border-red-500 h-16 flex items-center text-red-400";
                return false;
            }

            memoriaState = Array(MEM_SIZE).fill(0);
            for (let i = 0; i < Math.min(parsed.tokens.length, MEM_SIZE); i++) {
                memoriaState[i] = parsed.tokens[i];
            }

            pcState = parsedPc;
            outputState = "";
            ciclosState = 0;
            setRegs(null, null, null);
            return true;
        }

        function executarPasso() {
            if (pcState === null) {
                if (!prepararExecucao()) {
                    return;
                }
            }

            if (pcState < 0 || pcState >= MEM_SIZE) {
                statusDiv.innerHTML = "Execucao encerrada.";
                statusDiv.className = "mt-3 p-4 rounded-xl bg-slate-800 border border-slate-700 h-16 flex items-center text-slate-300";
                return;
            }

            const a = memoriaState[pcState];
            const b = memoriaState[pcState + 1];
            const c = memoriaState[pcState + 2];
            setRegs(a, b, c);

            if (a === undefined || b === undefined || c === undefined) {
                statusDiv.innerHTML = "Erro: instrucao incompleta encontrada.";
                statusDiv.className = "mt-3 p-4 rounded-xl bg-red-900/30 border border-red-500 h-16 flex items-center text-red-400";
                return;
            }

            if (b === -1) {
                const val = memoriaState[a] ?? 0;
                outputState += String.fromCharCode(val);
                pcState = c;
            } else {
                const valA = memoriaState[a] ?? 0;
                const valB = memoriaState[b] ?? 0;
                memoriaState[b] = valB - valA;
                if (memoriaState[b] <= 0) {
                    pcState = c;
                } else {
                    pcState += 3;
                }
            }

            ciclosState++;
            consoleDiv.innerText = "> " + (outputState || "(nada foi impresso)");
            statusDiv.innerHTML = `Passo executado. PC = ${pcState}`;
            statusDiv.className = "mt-3 p-4 rounded-xl bg-slate-800 border border-slate-700 h-16 flex items-center text-slate-300";
            renderMemory();
        }

        function executar() {
            if (!prepararExecucao()) {
                return;
            }

            const MAX_CICLOS = 2000;

            while (pcState >= 0 && pcState < MEM_SIZE && ciclosState < MAX_CICLOS) {
                const a = memoriaState[pcState];
                const b = memoriaState[pcState + 1];
                const c = memoriaState[pcState + 2];
                setRegs(a, b, c);

                if (a === undefined || b === undefined || c === undefined) {
                    statusDiv.innerHTML = "Erro: instrucao incompleta encontrada.";
                    statusDiv.className = "mt-3 p-4 rounded-xl bg-red-900/30 border border-red-500 h-16 flex items-center text-red-400";
                    return;
                }

                if (b === -1) {
                    const val = memoriaState[a] ?? 0;
                    outputState += String.fromCharCode(val);
                    pcState = c;
                } else {
                    const valA = memoriaState[a] ?? 0;
                    const valB = memoriaState[b] ?? 0;
                    memoriaState[b] = valB - valA;
                    if (memoriaState[b] <= 0) {
                        pcState = c;
                    } else {
                        pcState += 3;
                    }
                }
                ciclosState++;
            }

            consoleDiv.innerText = "> " + (outputState || "(nada foi impresso)");
            renderMemory();

            const normalized = outputState.replace(/\s+$/, "");
            if (normalized == "Hello, World!") {
                statusDiv.innerHTML = "Sucesso! Voce imprimiu 'Hello, World!'.";
                statusDiv.className = "mt-3 p-4 rounded-xl bg-green-900/30 border border-green-500 h-16 flex items-center text-green-400";
            }  else if(normalized === "https://youtu.be/dQw4w9WgXcQ?si=y_k9L8Sgpy8JUhg"){
            statusDiv.innerHTML = "Abra o link";
            statusDiv.addEventListener('click','https://youtu.be/dQw4w9WgXcQ?si=y_k9L8Sgpy8JUhg');
            }  else {
                statusDiv.innerHTML = "Falhou. Tente novamente.";
                statusDiv.className = "mt-3 p-4 rounded-xl bg-red-900/30 border border-red-500 h-16 flex items-center text-red-400";
            }
        }

        function carregarExemplo() {
            const code = "72 101 108 108 111 44 32 87 111 114 108 100 33";
            editorEl.value = code;
            syncMemoryFromEditor();
        }
        function carregarRR(){
        const code =   `15 17 -1 
17 -1 6 
16 1 -1 
16 3 -1 
15 15 0 
0 -1 104 
116 116 112
115 58 47 
47 121 111 
117 116 117 
46 98 101 
47 100 81 
119 52 119 
57 87 103 
88 99 81 
63 115 105 
61 121 95 
107 57 76 
56 83 103 
112 121 56 
74 85 104 
103 95 0`;
        document.getElementById('editor').value = code.trim();
    }

        function limparMemoria() {
            editorEl.value = "";
            memoriaState = Array(MEM_SIZE).fill(0);
            pcState = null;
            outputState = "";
            ciclosState = 0;
            consoleDiv.innerText = "> _";
            setRegs(null, null, null);
            statusDiv.innerHTML = "Memoria zerada.";
            statusDiv.className = "mt-3 p-4 rounded-xl bg-slate-800 border border-slate-700 h-16 flex items-center text-slate-300";
            renderMemory();
        }

        editorEl.addEventListener('input', () => {
            syncMemoryFromEditor();
        });

        syncMemoryFromEditor();
    </script>
</body>
</html>
